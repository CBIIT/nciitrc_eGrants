
@{
    ViewBag.Title = "egrants [Institutional Files]";
    Layout = "~/Shared/Views/_egrants_header.cshtml";
}

<link rel="stylesheet" type="text/css" href="~/Content/DragdropArea.css" />
<script src="~/scripts/dragdrop.js"></script>
<script src="~/scripts/ProgressBar.js"></script>

<style>
    .nav-tabs > li > a:hover {
        color: #ffffff;
        background-color: #808080 !important;
    }

    .nav-tabs > li > a:focus {
        color: #ffffff;
        background-color: #808080 !important;
    }
</style>

<script language="JavaScript">
        var currenturl = window.document.location.href;
        var frmdata = new FormData();
        var dropedfile;
        var DropFileCount = 0;
        var Categoryid = 0;
        var StartDate = "";
        var EndDate = "";

        $(document).ready(function () {
            load_default();
        });

        function load_default() {
            document.getElementById("index_list").style.display = "inline";
            var act = document.getElementById("hidACT").value;
            if (act == "create new") {
                var BrowserType = document.getElementById("hidBrowserType").value;
                if (act == "create new" && BrowserType.indexOf("Chrome") != -1 || BrowserType.indexOf("IE") != -1 || BrowserType.indexOf("InternetExplorer") != -1) {
                    switch_upload_mode("by_ddrop");
                } else switch_upload_mode("by_asp");
            }        
        }

        function search_orgs() {
            if (document.getElementById("txtStr").value == '') {
                alert("Please insert institution name to search");
                document.getElementById("txtStr").focus();
                return false;
            } else var search_str = document.getElementById("txtStr").value;

            var url = "@Url.Action("Search_Orgs", "InstitutionalFiles")?act=search_orgs&str=" + search_str;
            window.document.location.href = url;
        }

        function show_orgs(index_id) {
            var url = "@Url.Action("Show_Orgs", "InstitutionalFiles")?index_id=" + index_id;
            window.document.location.href = url;
        }

    function show_docs(org_id, org_name) {
            var url = "@Url.Action("Show_Docs", "InstitutionalFiles")?org_id=" + org_id+"&org_name="+org_name;
            window.document.location.href = url;
        }

        function delete_doc(doc_id, category_name, org_id, org_name) {
            var url = "@Url.Action("Delete_Doc", "InstitutionalFiles")?act=disable_doc&doc_id=" + doc_id + "&org_id=" + org_id + "&org_name=" + org_name;
            window.document.location.href = url;
        }

        function to_create_doc(org_name, org_id) {
            var url="@Url.Action("Show_Create_Doc", "InstitutionalFiles")?org_name=" + org_name + "&org_id=" + org_id;         
            window.document.location.href = url;
        }

        function switch_upload_mode(act) {
            if (act == "by_ddrop") {
                document.getElementById("by_ddrop").style.display = "inline";
                document.getElementById("by_asp").style.display = "none";
                Init();
            }

            if (act == "by_asp") {
                document.getElementById("by_asp").style.display = "inline";
                document.getElementById("by_ddrop").style.display = "none";
            }         
        }

        function select_category() {
            if (document.getElementById("ddlCategories").selectedIndex == 0) {
                alert("Please select category");               
                return false;
            }
            else {
                var el = "ShowFlag";
                var flag_data = document.getElementById("ddlCategories").options[document.getElementById("ddlCategories").selectedIndex].id;
                var tobe_flag = flag_data.charAt(0);
                var flag_period = flag_data.substring(2, (flag_data.length));

                if (tobe_flag == 1) {
                    if (document.getElementById(el).style.display == 'none') {
                        document.getElementById(el).style.display = "inline";

                        //get tart day
                        var currentDate = new Date();
                        var currDay = currentDate.getDate();
                        var currMonth = currentDate.getMonth() + 1;
                        var currYear = currentDate.getFullYear();

                        //get end date
                        currMonth = Number(currMonth) + Number(flag_period);
                        if (currMonth > 12) {
                            currMonth = Number(currMonth) - 12;
                            currYear = Number(currYear) + Number(1);
                        }
                        var end_date = currMonth + "/" + currDay + "/" + currYear;
                        document.getElementById("txtEndDate").value = end_date;
                    }
                } else document.getElementById(el).style.display = "none";
            }
        }

        function get_category_id() {
            if (document.getElementById("ddlCategories").selectedIndex == 0) {
                alert("Please select category");
                return false;
            } else Categoryid = document.getElementById("ddlCategories").options[document.getElementById("ddlCategories").selectedIndex].value;
                    return true;
        }

        function check_date_range() {
            //check start date
            if (document.getElementById("txtStartDate").value == '') {
                alert("Please insert start date");
                document.getElementById("txtStartDate").focus();
                return false;
            } else if (isDate(document.getElementById("txtStartDate").value) == false) {
                document.getElementById("txtStartDate").value = "";
                document.getElementById("txtStartDate").focus();
                return false;
            } else var start_date = new Date(document.getElementById("txtStartDate").value);

            //check end date
            if (document.getElementById("txtEndDate").value == '') {
                alert("Please insert end date");
                document.getElementById("txtEndDate").value = '';
                document.getElementById("txtEndDate").focus();
                return false;
            } else if (isAnyDate(document.getElementById("txtEndDate").value) == false) {
                document.getElementById("txtEndDate").value = '';
                document.getElementById("txtEndDate").focus();
                return false;
            } else var end_date = new Date(document.getElementById("txtEndDate").value);
       
            if (end_date <= start_date) {
                alert("The end date should be later than start date");
                document.getElementById("txtEndDate").value = '';
                document.getElementById("txtEndDate").focus();
                return false;
            }else   StartDate = document.getElementById("txtStartDate").value;  
                    EndDate = document.getElementById("txtEndDate").value;
                    //alert("EndDate=" + EndDate);
                    return true;
        }

        function create_doc_by_file(org_id, org_name) {
            //check loacte file, file type and file size
            if (check_file() == false) {
                return false;
            } 

            //find category_id
            if (get_category_id() == false) {
                return false;
            } else

            //find if to be flag
            var flag_data = document.getElementById("ddlCategories").options[document.getElementById("ddlCategories").selectedIndex].id;
            var tobe_flag = flag_data.charAt(0);

            //check start date and end date for site vist
            if (tobe_flag == 1) {
                if (check_date_range() == false) {
                    return false;
                } 
            }else {
                StartDate = "";
                EndDate = "";
            }

            //alert("EndDate=" + EndDate);
                       
            var file = document.getElementById('UploadFile').files[0];
            frmdata.append('file', file);
            frmdata.append('category_id', Categoryid);
            frmdata.append('org_id', org_id);
            frmdata.append('org_name', org_name);
            frmdata.append('start_date', StartDate);
            frmdata.append('end_date', EndDate);                  
            docupload(frmdata, "/InstitutionalFiles/Create_Doc_by_File");

            refresh_after_upload(org_id, org_name);
            //return true;
        }

        function create_doc_by_ddrop(org_id, org_name) {  
            if (get_category_id() == false) {
                return false;
            } else

            //find if to be flag
            var flag_data = document.getElementById("ddlCategories").options[document.getElementById("ddlCategories").selectedIndex].id;
            var tobe_flag = flag_data.charAt(0);

            //check start date and end date for site vist
            if (tobe_flag == 1) {
                if (check_date_range() == false) {
                    return false;
                }
            }else {
                StartDate = "";
                EndDate = "";
            }

            frmdata.append('dropedfile', dropedfile);
            frmdata.append('category_id', Categoryid);
            frmdata.append('org_id', org_id);
            frmdata.append('org_name', org_name);
            frmdata.append('start_date', StartDate);
            frmdata.append('end_date', EndDate);
            docupload(frmdata, "/InstitutionalFiles/Create_Doc_by_DDrop");

            refresh_after_upload(org_id, org_name);
            //return true;
        }

        function refresh_after_upload(org_id, org_name) {
            var url = "@Url.Action("Show_Docs", "InstitutionalFiles")?org_id=" + org_id + "&org_name=" + org_name;
            window.document.location.href = url;
        }

        function show_doc(docurl) {
            var ImageServer = document.getElementById("hidImageServer").value;
            //alert(docurl);
            if (docurl.substring(0, 5) == "/data") {
                var url = ImageServer + docurl.substring(1, docurl.length);
            }else if (docurl.substring(0, 5) == "data/") {
                var url = ImageServer + docurl;
            }else url = docurl;
            //alert(url);
            window.open(url);
        }
    </script>

    <form name="frmGetInfo">
        <input type="hidden" id="hidACT" name="act" value="@ViewBag.Act" />
        <input type="hidden" id="hidBrowserType" name="browser_type" value="@Convert.ToString(Session["browser"])" />
        <input type="hidden" id="hidImageServer" name="MImageServer" value="@Convert.ToString(Session["ImageServer"])" />  
    </form>

        <div id="main">
            <!--start main-->
            <div id="caption"><b id="page_title">Institution Master List</b></div>

            <div id="index_list" style="display:none">
                <b>Index:</b>
                @foreach (var index in ViewBag.CharacterIndex)
                {
                    <div id="index.index_id" style="display:inline">
                        <a href="JavaScript:show_orgs(@index.index_id)" title="Search Institution Files with @index.character_index">
                            <b>@char.ToUpper(index.character_index[0])</b>&#0160;
                        </a>
                    </div>
                }
            </div>
            <br /><br />
            <b>Institution Name:</b>&#0160;
            <input type="text" name="str" id="txtStr" class="smallfont" size="58" title="Insert institution name to search" value="@ViewBag.Str" />
            &#0160;
            <button type="button" class="btn btn-primary eGrantsDocBtn" accesskey="S" title="Search by institution name [shift + alt + S]" onClick="return search_orgs();"><u>S</u>earch</button>
            <br /><br />
            <!--start show orgs list-->
            @if (ViewBag.OrgFiles != null && ViewBag.OrgFiles.Count > 0)
            {
                <div>
                    <table>
                        @*<tr><td width="500"></td></tr>*@
                        @foreach (var org in ViewBag.OrgFiles)
                        {
                            if (Convert.ToInt16(org.tag) == 1)
                            {
                                <tr>
                                    <td style="height:15px; width:500px;">
                                        <a href="JavaScript:show_docs('@org.org_id','@org.org_name')" title="Click here to display documents list for @org.org_name"><b>@org.org_name</b></a>
                                        @foreach (var doc in ViewBag.OrgFiles)
                                        {
                                            if (Convert.ToInt16(doc.tag) == 2 && Convert.ToInt32(org.org_id) == Convert.ToInt32(doc.org_id))
                                            {
                                                <a target="_new" href="@doc.sv_url" title="Created by @doc.created_by at @doc.created_date and expired date will be @doc.end_date">
                                                    <img style="height:16px; vertical-align:top;" src="~/Content/images/Site_Visit.png" />
                                                </a>
                                            }
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </table>
                </div>
            }
            <!--end show orgs list-->

            <!--start show docs list-->
            @if (ViewBag.Act != "show_orgs" && ViewBag.OrgCategory== null)
            {
                <!--get org infor-->
                //var OrgID = 0;
                //var OrgName = "";
                //if (ViewBag.OrgFiles.Count == 1)
                //{
                //    foreach (var org in ViewBag.OrgFiles)
                //    {
                //        OrgID = Convert.ToInt32(org.org_id);
                //        OrgName = org.org_name;
                //    }
                //}

            <table width="850" valign="left">
                <tr>
                    <td width="250"><b>@ViewBag.OrgName</b></td>
                    <td width="150">
                        @if (ViewBag.OrgID != null && ViewBag.OrgID > 0)
                        {
                            <a href="JavaScript:to_create_doc('@ViewBag.OrgName','@ViewBag.OrgID')" title="Click here to create new document">Create New Document</a>
                        }
                        @*else if (OrgID > 0 && OrgName !="")
                        {
                          <a href="JavaScript:to_create_doc('@OrgName','@OrgID')" title="Click here to create new document">Create New Document</a>                          
                        }*@
                    </td>
                </tr>                      
                <tr>
                    <td colspan="2">
                        <table>
                            <tr>
                                <td width="250" class="bg_grey"><lable for="Category"><center><b>Category Name</b></center></lable></td>
                                <td width="150" class="bg_grey"><lable for="document date"><center><b>Document Date</b></center></lable></td>
                            </tr>
                            @if (ViewBag.Act == "show_docs" && ViewBag.DocFiles!=null) { 
                                foreach (var docs in ViewBag.DocFiles)
                                {
                                    if (Convert.ToInt16(docs.tag) == 2)
                                    {
                                    <tr>
                                        <td>
                                            <a href="JavaScript:show_doc('@docs.url')" title="Click here to display document">@docs.category_name</a>
                                        </td>
                                        <td>@docs.created_date&#0160;&#0160;&#0160;&#0160;
                                            <a href="JavaScript:delete_doc('@docs.document_id', '@docs.category_name','@docs.org_id', '@ViewBag.OrgName')" title="Click here to delete this document">
                                                <img class="img_12_12" SRC="~/Content/images/Clear.jpg" />
                                            </a>
                                        </td>
                                    </tr>
                                    }
                                }
                            }
                            </table>
                        </td>
                    </tr>
            </table>
            }
            <!--end show docs list-->

            <!--start create new doc-->
            @if (ViewBag.OrgCategory != null)
            {
            <div>
                <table width="800">
                    <tr height="20">
                        <td width="100"><lable for="Institute"><b>Institute:</b></lable></td>
                        <td width="700"><b>@ViewBag.OrgName</b></td>
                    </tr>
                    <tr height="20">
                        <td><lable for="Category"><b>Category:</b></lable></td>
                        <td>
                            <select name="category_id" id="ddlCategories" class="smallfont" size="1" title="Select category to create new document" OnChange="select_category()">
                                <option value="0"></option>
                                @foreach (var orgcategory in ViewBag.OrgCategory)
                                {
                                    <option id="@orgcategory.flag_data" value="@orgcategory.category_id">@orgcategory.category_name</option>
                                }
                            </select>
                        </td>
                    </tr>
                    <tr height="20">
                        <td><lable for="flag"><b>Show Flag:</b></lable></td>
                        <td>
                            <div id="ShowFlag" style="display:none">
                                <lable for="start date"><b>From</b></lable>
                                &#0160;
                                <input type="text" name="start_date" id="txtStartDate" class="smallfont" size="8" title="Insert start date" value="@ViewBag.Today" />&#0160;
                                <lable for="end date"><b>To</b></lable>&#0160;
                                <input type="text" name="end_date" id="txtEndDate" class="smallfont" size="8" title="Insert end date" />
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <!--show loading icon-->
                            <div class="loading" style="display:none">
                                <img src="~/Content/images/Loading.gif" width="80" />
                            </div>
                        </td>
                        <td>
                            <ul class="nav nav-tabs">
                                <li class="active"><a href="Javascript:switch_upload_mode('by_ddrop')">Drag & Drop</a></li>
                                <li></li>
                                <li class="active"><a href="Javascript:switch_upload_mode('by_asp')">Locate File and Upload</a></li>                            
                            </ul>
                            <div class="tab-content" id="TabUploadContent">                               
                                <!--start upload by drag drop -->
                                <div class="tab-pane fade active in" id="by_ddrop" style="display:inline">
                                    <br />
                                    <div id="dropArea">
                                        Drag-drop only one file here to upload
                                    </div>
                                    <br />
                                    <button type="button" id="btnDragdrop" name="btnCreateNew" class="btn btn-primary eGrantsDocBtn" accesskey="C" title="Click here to create new [shift + alt + C]" onclick="return create_doc_by_ddrop('@Convert.ToInt32(ViewBag.OrgID)', '@Convert.ToString(ViewBag.OrgName)');" disabled="disabled"><u>C</u>reate New</button>
                                </div>
                                <!--end upload by drag drop-->

                                <!--sstart upload by file-->
                                <div class="tab-pane fade active in" id="by_asp" style="display:none">                             
                                    <br/>
                                    <input type="file" name="file" id="UploadFile" />     
                                    <br/>                                     
                                    <button type="button" id="btnFileUpload" name="btnCreate" class="btn btn-primary eGrantsDocBtn" accesskey="C" title="Click here to create new [shift + alt + C]" onclick="return create_doc_by_file('@Convert.ToInt32(ViewBag.OrgID)', '@Convert.ToString(ViewBag.OrgName)')"><u>C</u>reate New</button>                              
                                </div>
                                @*<br />*@
                                <!--end upload by file-->                          
                                <!--start progree bar-->
                                @*<br />*@
                                <div class="progress" style="display:none; margin:0; padding:0;">
                                    <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%; height:18px; text-align: center; line-height:18px; " aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <!--end progree bar-->
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>                         
                            <button onclick="javascript: show_docs('@Convert.ToInt32(ViewBag.OrgID)', '@Convert.ToString(ViewBag.OrgName)')" class="btn btn-primary eGrantsReturnBtn" accesskey="R" title="Click here to return previous page [alt + shift + R]"><u>R</u>eturn</button>&#0160;&#0160;
                            @if (ViewBag.FileUrl != null)
                            {
                                <a target="_new" href="@ViewBag.FileUrl" title="Click here to check uploaded file"><img src="../Content/images/check_doc_btn.png" style="height:35px;" title="Check Document" /></a>                            
                            }              
                            <b>@ViewBag.Message</b>
                        </td>
                    </tr>
                </table>
            </div>

                @*<a href="javascript:show_docs('@Convert.ToInt32(ViewBag.OrgID)', '@Convert.ToString(ViewBag.OrgName)')" title="Click here to return [shift + alt + R]">Return</a>
                <br />
                <b>@ViewBag.Message</b>
                <br/>
                if (ViewBag.FileUrl != null)
                {
                    <a target="_new" href="@ViewBag.FileUrl" title="Click here to check uploaded file">Check Uploaded File</a>
                }*@              
        }
    <!--end create new doc--->           
</div><!--end main-->
