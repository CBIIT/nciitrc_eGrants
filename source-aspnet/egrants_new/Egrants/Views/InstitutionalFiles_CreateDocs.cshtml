@*@using Newtonsoft.Json*@
@model egrants_new.Egrants.Models.InstitutionallFilesPage
@using System.Web.Script.Serialization
<style>

    table {
        table-layout: fixed;
    }


    .xrow {
        line-height: 20px !important;
    }

    .not-shown {
        visibility: hidden;
    }

    .inline {
        display: inline-block;
    }

    .left-col {
        width: 100px !important;
    }

    .right-col {
        width: 700px !important;
        display: inline;
    }

    .comment-text {
        width: 200px;
    }
</style>

<script>

    $(document).ready(function () {

        $("#comments").on('keypress',function(event) {
            check_comment_length(event);
        });
    });


    //$('#txtStartDate').datepicker({
    //    showOn: 'both',
    //    buttonImage: '../Content/images/calendar.png'
    //    //border: '0',
    //    //border-color: 'white''
    //});

    //$('#txtEndDate').datepicker({
    //    showOn: 'both',
    //    buttonImage: '../Content/images/calendar.png'
    //    //border: '0',
    //    //border-color: 'white''
    //});

    @{
        var javaScriptSearilizer = new JavaScriptSerializer();
        var catArray = javaScriptSearilizer.Serialize(Model.OrgCategories.ToArray());
    }
    var categories = @Html.Raw(catArray);
    var Comments = "";

        function switch_upload_mode(act) {
            if (act == "by_ddrop") {
                document.getElementById("by_ddrop").style.display = "inline";
                document.getElementById("by_asp").style.display = "none";
                Init();
            }

            if (act == "by_asp") {
                document.getElementById("by_asp").style.display = "inline";
                document.getElementById("by_ddrop").style.display = "none";
            }
        }

        function select_category() {
            if (document.getElementById("ddlCategories").selectedIndex == 0) {
                alert("Please select category");
                return false;
            }
            else {
                //Find the div
                var sf_block = $("#ShowFlag");
                var c_block = $("#comments");
                var catId = document.getElementById("ddlCategories").options[document.getElementById("ddlCategories").selectedIndex].value;
                var category = categories.find(c => c.category_id === catId);

            if (Number(category.tobe_flag) === 1) {
                sf_block.removeClass("not-shown");
                var flag_period = category.flag_period;

                //get start day
                var currentDate = new Date();
                var currDay = currentDate.getDate();
                var currMonth = currentDate.getMonth() + 1;
                var currYear = currentDate.getFullYear();
                var end_date = "";
                //get end date
                var addMonths = 0;
                var addYears = 0
                if (flag_period != "") {
                    addYears = Math.floor(flag_period / 12);
                    addMonths = (flag_period % 12);
                    currMonth = currMonth + addMonths;
                    currYear = currYear + addYears;
                    end_date = currMonth + "/" + currDay + "/" + currYear;
                } else {
                    end_date = "";
                    }

                document.getElementById("txtEndDate").value = end_date;

            } else {
                sf_block.addClass("not-shown");
            }

            if (Number(category.require_comments) === 1) {
                c_block.removeClass("not-shown");
            } else {
                c_block.addClass("not-shown");
                }
       }
    }

    function get_category_id() {
        if (document.getElementById("ddlCategories").selectedIndex == 0) {
//            alert("Please select category");
            return false;
        } else Categoryid = document.getElementById("ddlCategories").options[document.getElementById("ddlCategories").selectedIndex].value;
        return true;
    }

    function check_date_range() {
        //check start date
        if (document.getElementById("txtStartDate").value == '') {
            alert("Please insert start date");
            document.getElementById("txtStartDate").focus();
            return false;
        } else if (isDate(document.getElementById("txtStartDate").value) == false) {
            document.getElementById("txtStartDate").value = "";
            document.getElementById("txtStartDate").focus();
            return false;
        } else var start_date = new Date(document.getElementById("txtStartDate").value);

        //check end date
        if (document.getElementById("txtEndDate").value == '') {
            alert("Please insert end date");
            document.getElementById("txtEndDate").value = '';
            document.getElementById("txtEndDate").focus();
            return false;
        } else if (isAnyDate(document.getElementById("txtEndDate").value) == false) {
            document.getElementById("txtEndDate").value = '';
            document.getElementById("txtEndDate").focus();
            return false;
        } else var end_date = new Date(document.getElementById("txtEndDate").value);

        if (end_date <= start_date) {
            alert("The end date should be later than start date");
            document.getElementById("txtEndDate").value = '';
            document.getElementById("txtEndDate").focus();
            return false;
        } else StartDate = document.getElementById("txtStartDate").value;
        EndDate = document.getElementById("txtEndDate").value;
        //alert("EndDate=" + EndDate);
        return true;
    }



    function check_comment_length(event) {

        Comments = $("#comments").val();

        if (Comments.length >= 50) {
            //alert("The Comments are not to exceed 50 Characters");
            $("#comments").val(Comments.substr(0, 50));
            $("#comment-warning").removeClass("not-shown");
            event.preventDefault();
        }
        else {
            $("#comment-warning").addClass("not-shown");
        }

    }


    function check_comment() {

        Comments = $("#comments").val();
        //alert(Comments);
        var catId = document.getElementById("ddlCategories").options[document.getElementById("ddlCategories").selectedIndex].value;
        var category = categories.find(c => c.category_id === catId);

        if (Comments.length == 0 && category.require_comments == 1) {
            alert("The Comments are required for category " + category.category_name);
            return false;
        }

        if (Comments.length > 50 && category.require_comments == 1) {
            alert("The Comments are not to exceed 50 Characters");
            return false;
        }

        return true;

    }

    function create_doc_by_file(org_id, org_name) {
        //check loacte file, file type and file size
        if (check_file() === false) {
            return false;
        }

        //find category_id
        if (get_category_id() === false) {
            return false;
        } else
        //find if to be flag
            var flag_data = document.getElementById("ddlCategories").options[document.getElementById("ddlCategories").selectedIndex].id;
        var tobe_flag = flag_data.charAt(0);

        //check start date and end date for site vist
        if (tobe_flag == 1) {
            if (check_date_range() === false) {
                return false;
            }
        } else {
            StartDate = "";
            EndDate = "";
        }
        if (check_comment() == false) {
            return false;
        }

        //alert("EndDate=" + EndDate);

        var file = document.getElementById('UploadFile').files[0];
        frmdata.append('file', file);
        frmdata.append('category_id', Categoryid);
        frmdata.append('org_id', org_id);
        frmdata.append('org_name', org_name);
        frmdata.append('start_date', StartDate);
        frmdata.append('end_date', EndDate);
        frmdata.append('comments', Comments);
        docupload(frmdata, "/InstitutionalFiles/Create_Doc_by_File");

        setTimeout(function() {
                refresh_after_upload(org_id, org_name);
            },
            500);
        //return true;
    }

    function create_doc_by_ddrop(org_id, org_name) {
        if (get_category_id() == false) {
            return false;
        } else
        //find if to be flag
            var flag_data = document.getElementById("ddlCategories").options[document.getElementById("ddlCategories").selectedIndex].id;
        var tobe_flag = flag_data.charAt(0);

        //check start date and end date for site vist
        if (tobe_flag == 1) {
            if (check_date_range() == false) {
                return false;
            }
        } else {
            StartDate = "";
            EndDate = "";
        }

        if (check_comment() == false) {
            return false;
        }

        frmdata.append('dropedfile', dropedfile);
        frmdata.append('category_id', Categoryid);
        frmdata.append('org_id', org_id);
        frmdata.append('org_name', org_name);
        frmdata.append('start_date', StartDate);
        frmdata.append('end_date', EndDate);
        frmdata.append('comments', Comments);
        docupload(frmdata, "/InstitutionalFiles/Create_Doc_by_DDrop");

        setTimeout(function() {
                refresh_after_upload(org_id, org_name);
            },
            500);
        //return true;
    }

</script>




<div>
    <table>
        <tr>
            <td width="800px" class="text-left">
                <table width="800px">
                    <tr style="overflow: hidden; line-height: 20px !important;" class="xrow" >
                        <td class="left-col">
                            <b>Institute:</b>
                        </td>
                        <td class="right-col">
                            <b>@Model.SelectedInstitutionalOrg.OrgName</b>
                        </td>
                    </tr>
                    <tr style="overflow: hidden; line-height: 20px !important;" class="xrow">
                        <td class="left-col"><label for="Category"><b>Category:</b></label></td>
                        <td class="right-col">
                            <select name="category_id" id="ddlCategories" class="smallfont" size="1" title="Select category to create new document" OnChange="select_category()">
                                <option value="0"></option>
                                @foreach (var orgcategory in Model.OrgCategories)
                                {
                                    <option id="@orgcategory.flag_data" value="@orgcategory.category_id">@orgcategory.category_name</option>
                                }
                            </select>
                            <span><input type="text" class="comment-text not-shown" id="comments" class="smallfont " size="8" title="" />&nbsp;<label style="display: inline-block;" id="comment-warning" class="text-danger not-shown">Comment length cannot exceed 50 Characters.</label></span>
                        </td>
                    </tr>
                    <tr style="overflow: hidden; line-height: 20px !important;"   id="ShowFlag" class="xrow not-shown">
                        <td class="left-col"><label for="flag"><b>Show Flag:</b></label></td>
                        <td class="right-col" width="600px">
                            <div class="inline">
                                <label for="start date"><b>From</b></label>
                                &#0160;
                                <input type="text" name="start_date" id="txtStartDate" class="smallfont" size="8" title="Insert start date" value="@Model.TodayText" />&#0160;
                                <label for="end date"><b>To</b></label>&#0160;
                                <input type="text" name="end_date" id="txtEndDate" class="smallfont" size="8" title="Insert end date" />
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="left-col">
                            <!--show loading icon-->
                            <div class="loading" style="display:none">
                                <img src="~/Content/images/Loading.gif" width="80" />
                            </div>
                        </td>
                        <td class="right-col">
                            <ul class="nav nav-tabs">
                                <li class="active"><a href="Javascript:switch_upload_mode('by_ddrop')">Drag & Drop</a></li>
                                <li></li>
                                <li class="active"><a href="Javascript:switch_upload_mode('by_asp')">Locate File and Upload</a></li>
                            </ul>
                            <div class="tab-content" id="TabUploadContent">
                                <!--start upload by drag drop -->
                                <div class="tab-pane fade active in" id="by_ddrop" style="display:inline">
                                    <br />
                                    <div id="dropArea">
                                        Drag-drop only one file here to upload
                                    </div>
                                    <br />
                                    <button type="button" id="btnDragdrop" name="btnCreateNew" class="btn btn-primary eGrantsDocBtn" accesskey="C" title="Click here to create new [shift + alt + C]" onclick="return create_doc_by_ddrop('@Model.SelectedInstitutionalOrg.OrgId', '@Model.SelectedInstitutionalOrg.OrgName');" disabled="disabled"><u>C</u>reate New</button>
                                    <div style="display:inline">By clicking Create New, I confirm that no sensitive PII or PHI is included in this file.</div>
                                </div>
                                <!--end upload by drag drop-->
                                <!--sstart upload by file-->
                                <div class="tab-pane fade active in" id="by_asp" style="display:none">
                                    <br />
                                    <input type="file" name="file" id="UploadFile" />
                                    <br />
                                    <button type="button" id="btnFileUpload" name="btnCreate" class="btn btn-primary eGrantsDocBtn" accesskey="C" title="Click here to create new [shift + alt + C]" onclick="return create_doc_by_file('@Model.SelectedInstitutionalOrg.OrgId', '@Model.SelectedInstitutionalOrg.OrgName')"><u>C</u>reate New</button>
                                    <div style="display:inline">By clicking Create New, I confirm that no sensitive PII or PHI is included in this file.</div>

                                </div>

                                @*<br />*@
                                <!--end upload by file-->
                                <!--start progree bar-->
                                @*<br />*@
                                <div class="progress" style="display:none; margin:0; padding:0;">
                                    <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%; height:18px; text-align: center; line-height:18px; " aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <!--end progree bar-->
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="left-col"></td>
                        <td class="right-col">
                            <button onclick="javascript: show_docs('@Model.SelectedInstitutionalOrg.OrgId', '@Model.SelectedInstitutionalOrg.OrgName')" class="btn btn-primary eGrantsReturnBtn" accesskey="R" title="Click here to return previous page [alt + shift + R]"><u>R</u>eturn</button>&#0160;&#0160;
                            @if (ViewBag.FileUrl != null)
                            {
                                <a target="_new" href="@ViewBag.FileUrl" title="Click here to check uploaded file"><img src="../Content/images/check_doc_btn.png" style="height:35px;" title="Check Document" /></a>
                            }
                            <b>@ViewBag.Message</b>
                        </td>
                    </tr>
                </table>
            </td>
            <td>
                <div valign="top" style="box-shadow: 0 3px 10px rgb(0 0 0 / 0.5); width: 350px; height: 260px; line-height: normal; font-style: normal; vertical-align: text-top; padding-left: 15px;"><br><br /><b>Reminder:</b> Sensitive Personally Identifiable Information (PII; e.g. Social Security Number, personal financial information, Alien Registration Number, etc.) or Protected Health Information (e.g. personal medical conditions, etc.) requires strict handling due to the increased risk to an individual if the data is compromised. Documents containing sensitive PII or PHI must not be uploaded into eGrants. More information can be found in the <a target="_new" href="https://policymanual.nih.gov/manage/chapter/view/1745">Manual Chapter 1745 - NIH Information Technology (IT) Privacy Program</a>.</div>
            </td>
        </tr>
    </table>
</div>
